---
- name: Run gpu exporters on servers
  gather_facts: true
  hosts: nodes
  tasks:
    - name: Copy sm exporter image tar file from host to servers
      ansible.builtin.copy:
        src: /tmp/sm-exporter.tar
        dest: /home/sm-exporter.tar

    - name: Copy gpu exporter image tar file from host to servers
      ansible.builtin.copy:
        src: /tmp/gpu-exporter.tar
        dest: /home/gpu-exporter.tar

    - name: Load sm image from archive
      docker_image:
        name: docker-hub.tip.co.ir/targoman/nvidia-exporter:latest
        load_path: /home/sm-exporter.tar
        source: load
        state: present

    - name: Load gpu image from archive
      docker_image:
        name: docker.tip.co.ir/targoman/gpu-exporter:latest
        load_path: /home/gpu-exporter.tar
        source: load
        state: present

    - name: Copy compose file from host to target
      ansible.builtin.copy:
        src: ./exporter-compose.yaml
        dest: /home/exporter-compose.yaml

    - name: Install docker-compose from official github repo
      ansible.builtin.copy:
        src: ~/DevOps/docker-compose-linux-x86_64
        dest: /home/docker-compose
+
    - name: give compose binary execute permission
      ansible.builtin.file:
        dest: /home/docker-compose
        mode: 'a+x'

    - name: Run the docker compose file
      shell: /home/docker-compose -f /home/exporter-compose.yaml up -d
